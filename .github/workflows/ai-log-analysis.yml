name: ü§ñ AI Log Analysis

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - run: pip install requests
      
      - name: ü§ñ Analisar logs
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          cd aula07-ia-logs
          python analyze_logs_ci.py
      
      - name: üìä Gerar Sum√°rio
        if: always()
        run: |
          cd aula07-ia-logs
          echo "## ü§ñ AI Log Analysis - Sum√°rio" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìã Resultado da An√°lise:" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          cat log-analysis.json >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
      
      - name: üö® Criar issue se cr√≠tico
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const analysis = JSON.parse(fs.readFileSync('aula07-ia-logs/log-analysis.json', 'utf8'));
              if (analysis.status === 'critical') {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: 'üö® Problema cr√≠tico detectado nos logs',
                  body: `**Status:** ${analysis.status}\n**Erros:** ${analysis.errors_found}\n**Problema:** ${analysis.main_issue}\n**Recomenda√ß√£o:** ${analysis.recommendation}`,
                  labels: ['bug', 'critical']
                });
                console.log('Issue criada com sucesso!');
              } else {
                console.log('Status n√£o √© cr√≠tico, issue n√£o criada.');
              }
            } catch (e) {
              console.log('Arquivo n√£o encontrado ou erro:', e.message);
            }
